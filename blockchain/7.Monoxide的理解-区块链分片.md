# Monoxide的理解 - 区块链分片
(本文属于原创内容，首发于https://github.com/dragon-distributed/book , 未经作者许可，不得转载。)  

## 背景

Paper全称为：Monoxide - Scale out Blockchains with Asynchronous Consensus Zones，是2019年在计算机顶级学术会议NSDI中收录的，这是继2017年Algorand之后，又一篇关于区块链的顶级论文。  

Paper主要提出三个核心思路：  
1) 分片：将区块链划分为N个Zone，每个Zone自治。    
2) 跨Zone事务最终原子性：解决跨Zone事务。    
3) Chu-ko-nu Mining 诸葛连弩挖矿：解决划分Zone之后，每个Zone的安全性问题。  

## 分片

### 问题提出

在传统的区块链中，虽然有很多节点参与，但是，每个节点都需要做相同的事情：  
1) Replicate：每个节点都需要复制相同的数据，占用network资源。   
2) Validate：每个节点都需要校验相同的数据，占用CPU资源。  
3) Store：每个节点都需要存储相同的数据，占用磁盘资源。  
4) Memory：每个节点都需要维护相同的进程数据，占用内存资源。  

这导致整个区块链无法scale out，区块链的性能甚至不如一台普通pc服务器的性能。  

区块链扩容主要有两种方式，一种是off-chain，如状态通道：闪电、雷电网络，如侧链：Liquid。另一种则是on-chain，如硬分叉、网络优化、还有分片，Monoxide则是分片解决方案。  
   
### 如何分片

将区块链分为n个Zone，每个Zone互相独立。n=2^k 次方，每个User Address，根据前k个bits，划分到不同的Zone，如下图所示：  

![图1](https://longdandan-1256672193.cos.ap-guangzhou.myqcloud.com/article/blockchain/7.zone.jpg)

每个Zone互相独立，即具备了scale out的能力，性能理论上可以放大n倍。

## 跨Zone事务最终原子性

每个用户，根据自己的address，落在具体的Zone上。如果一笔交易，input与ouput都是在同一个Zone上，则比较容易处理。  

但现实的情况是，更多的交易都需要跨Zone进行。Paper中指出，当Zone数达到64个时，95%的交易都需要跨Zone进行。**跨Zone的交易，又属于分布式事务的范畴**。  

Monoxide使用的是Eventual Atomicity，即最终原子性。此方案的可接受程度，得益于区块链用户习惯于延后确认的交易模式。  

Monoxide将一个交易分为两部分，一部分是conditional operation，另一部分则是unconditional operation。很显然，如果一笔交易是，将x token从A用户转到B用户，那么：  

1) conditional operation = A - x  
2) unconditional operation = B + x  

交易会分两部分进行，先执行conditional operation，成功后，再执行unconditional operation，如下图：  

![图2](https://longdandan-1256672193.cos.ap-guangzhou.myqcloud.com/article/blockchain/7.cross%20zone%20tx.jpg)

conditional operation在本Zone A执行， 放入Transaction-Block中，需要执行的unconditional operation，则由Zone A输出Outbound Relay TX，由Zone B执行。如下图：  

![图3](https://longdandan-1256672193.cos.ap-guangzhou.myqcloud.com/article/blockchain/7.cross%20zone%20tx%20detail.jpg)

总体上是这样子的：  

![图4](https://longdandan-1256672193.cos.ap-guangzhou.myqcloud.com/article/blockchain/7.cross%20zone%20tx%20overall.jpg)

看上去似乎不难，但是，还是有一些重要的，潜在的问题需要解决的。  

### Fork的情况

不像传统的分布式系统，一旦ack client，则此operation一定会是成功的。传统的基于PoW的区块链，存在分叉的可能。  

这意味着，一个conditional operation，如A-x，在执行完，输出Relay Tx (B+x)之后，这个conditional operation可能会被回滚（被其它链代替导致不执行），而Relay Tx已经执行了，导致整个Transaction异常。  

原文的解决办法是："To avoid such a case, a miner will validate candidate transactions against a special state by delaying execution of inbound relay transaction for y blocks."  

本人的理解是（非100%确认），对于inbound relay transaction，要延迟y个block执行，这个y一般是confirm blocks的长度，如BTC是6。这样的话，就保证了conditional operation一定是成功的。  

而依赖于这个transaction的其它transaction，则要求等这个transaction被执行后，才能开始打包。  

### Relay Transaction不打包的情况

将一个transaction分成两部分，那么会不会出现，conditional operation被执行了，将relay transaction(unconditional operation) output到Zone B，但Zone B不打包此transaction呢？会不会expire被移除？  

Paper中指出，对于Relay Transaction，是会有fee的，所以会被最终打包，而且，对于Relay Transaction，是有机制保证它永不过期（除非conditional operation被替换了）。在非常极端的环境下，如果Relay Transaction被丢失了，原始的Zone可以重建此Relay Transaction。  

## Chu-ko-nu Mining 诸葛连弩挖矿

### 背景 - 安全性问题

假设一个PoW区块链，有n个节点，那么51%攻击就是需要 k > n*50%个节点。但如果划分Zone了，假设是m个Zone，则51%攻击只需要 k > n/m * 51%，大大减少了攻击成本。  

那么，如何解决呢？  

### Chu-ko-nu Mining

连弩的本质是一次可以发射多支箭，放在区块链中，则是一次挖矿（nonce），可以产生多个Zone的区块。如下图所示：  

![图5](https://longdandan-1256672193.cos.ap-guangzhou.myqcloud.com/article/blockchain/7.mining%20overview.jpg)

一次挖矿，可以生成多个Zone的区块，从经济角度上，驱使矿工参与尽可能多的Zone的挖矿，使得安全性趋向于传统的区块链。  

### Independent Validation in Zones

当矿工使用连弩挖矿，生成一个包含N Zones的结果，对于每个Zone，它是独立验证的。这意味着，同一次的挖矿生成的结果，可以是，某些Zone是接受，某些Zone拒绝。如下图所示：  

![图6](https://longdandan-1256672193.cos.ap-guangzhou.myqcloud.com/article/blockchain/7.mining.jpg)


## 总结

Monoxide使用分片的方式，使用区块链可以scale out。主要思路是：  
1）制定分区规则    
2）解决分区带来的问题：最终原子性  
3）使用连弩挖矿解决安全性问题以及效率问题  