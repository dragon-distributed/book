# hbase与hadoop的一些关键点

最近工作上需要用到hbase与hadoop，本文将调研的一些关键点markdown一下，相关的版本号是hbase2.1.0, hadoop3.1.1。

本文打算使用case by case的方式介绍，重点在于存储、复制部分。


##1. hdfs的replication是同步的还是异步的？
 (hdfs replication is synchronously or asynchronous?)
 
 **最终答案是同步的(confirm: synchronously)** (以下为过程，如果不想了解可以跳过) 
 

>因为做分布式系统较多，所以一开始就尝试拿着quorum这种思想去了解hdfs，走了一些弯路。
 
>首先看看hdfs相关paper的资料，如下图：
 
![write in hdfs](https://github.com/dragon-distributed/book/blob/master/nosql/material/1.hdfs%20write.jpg)
 
>很明显，这就是个链式复制，而且ack是要等所有DNs ack之后才ack client的。
 
>但是，在测试时使用dfs.replication=3，只有一个datanode时，写入竟然成功了。让我对同步的结论有一些怀疑（毕竟hadoop经历了这么多的版本）

 
##2. 为什么在dfs.replication=3，只有一个datanode时，写入是成功的？??

**最终答案是：dfs.replication控制最终的副本数，如果写入时，有N个副本活着(N<dfs.replication)，则写入N个副本也算成功，但写入这N个副本是同步的。dfs.namenode.replication.min只是控制cluster最少的datanodes数量，少于这个数量则进入safemode，与chain write的ack数无关。**(以下为过程，如果不想了解可以跳过) 


>由于这个问题，所以有个dfs.namenode.replication.min的配置引起了注意。直观上这个配置控制了min replication ack数量，比如设为2，则意味着同步写了2副本之后，就马上返回，第3个副本是异步同步的。通过google搜索(hdfs replication async or sync)，第一个答案: https://stackoverflow.com/questions/12442764/how-to-force-synchronous-hdfs-replication ，确实也是这样写的。
 
>但是，在之后的YCSB时，3个datanodes，在dfs.namenode.replication.min为2与3时，性能是一样的，引起了我的怀疑。
>
>经过一系统测试，确认了上述的最终答案。(网上也有一些论证：https://community.hortonworks.com/questions/148457/if-it-is-the-case-of-3-node-cluster-we-have-1-node.html)
>
>ps: 对于细节，不能只看不做...

 

##3. HBase在写入hdfs时，既然是链式复制，为什么在DN数为1与3的情况下，性能相差不大？

**最终答案是：hbase2.x开始，添加了asyncfs(fan-out)的实现(修改了hdfs的客户端)。具体可以见：https://www.slideshare.net/HBaseCon/apache-hbase-improvements-and-practices-at-xiaomi**


##4. 其它关键问题

1) hbase client的每个请求，是否一定写完WAL再ack?
**最终答案是: yes**

2) hbase asyncfs的实现，是否等所有DN返回才算写入成功?
**最终答案是: yes**

3) hbase asyncfs的实现，若DN数少于dfs.replication数，是什么机制?
**最终答案是: 与chain复制一样，若 N < fs.replication (N为活动的DN数），则写入N个DN后算是成功**

4) hbase asyncfs 是如何让hdfs的DN不自己复制？
**最终答案是: hdfs里client和dn通信的协议里有，dn要不要往其他dn写是client告诉他的，fan-out的时候client告诉每个DN只写自己就行**


